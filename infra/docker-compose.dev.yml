version: "3.9"

networks:
  greenly_network:
    name: greenly_network

volumes:
  mysql_data:
  mongo_data:
  redis_data:
  core_node_modules:
  catalog_node_modules:
  ml_venv:
  go_mod_cache:

services:

  # ==============================
  # TRAEFIK API GATEWAY
  # ==============================
  traefik:
    image: traefik:v2.11
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=greenly_network"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - greenly_network

  # ==============================
  # DATABASES
  # ==============================
  mysql:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: greenly_core
      MYSQL_USER: greenly
      MYSQL_PASSWORD: greenly
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - greenly_network

  mongodb:
    image: mongo:7
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - greenly_network

  redis:
    image: redis:7
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - greenly_network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: greenly_rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - greenly_network

  # ==============================
  # CORE SERVICE (NODE)
  # ==============================
  core-service:
    build:
      context: ../services/core-service
      dockerfile: Dockerfile.dev

    depends_on:
      - mysql
      - redis
      - rabbitmq

    environment:
      DATABASE_HOST: mysql
      DATABASE_PORT: 3306
      DATABASE_USER: greenly
      DATABASE_PASSWORD: greenly
      DATABASE_NAME: greenly_core
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/

    develop:
      watch:
        # ðŸ”¥ Sync source â†’ hot reload
        - action: sync
          path: ../services/core-service
          target: /app
          ignore:
            - node_modules/
            - dist/

        # ðŸ”¥ Rebuild kalau dependency berubah
        - action: rebuild
          path: ../services/core-service/package.json

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.core.rule=PathPrefix(`/api/core`)"
      - "traefik.http.routers.core.entrypoints=web"
      - "traefik.http.services.core.loadbalancer.server.port=3000"
      - "traefik.http.middlewares.core-strip.stripprefix.prefixes=/api/core"
      - "traefik.http.routers.core.middlewares=core-strip"

    networks:
      - greenly_network
  # ==============================
  # ML ENGINE (FASTAPI)
  # ==============================
  ml-engine:
    build:
      context: ../services/ml-engine
      dockerfile: Dockerfile.dev

    depends_on:
      - redis
      - rabbitmq

    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/

    develop:
      watch:
        - action: sync
          path: ../services/ml-engine
          target: /app

        - action: rebuild
          path: ../services/ml-engine/pyproject.toml

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ml.rule=PathPrefix(`/api/ml`)"
      - "traefik.http.routers.ml.entrypoints=web"
      - "traefik.http.services.ml.loadbalancer.server.port=8000"
      - "traefik.http.middlewares.ml-strip.stripprefix.prefixes=/api/ml"
      - "traefik.http.routers.ml.middlewares=ml-strip"

    networks:
      - greenly_network

  ml-worker:
    build:
      context: ../services/ml-engine
      dockerfile: Dockerfile.dev
    command: uv run celery -A app.celery worker --loglevel=info
    volumes:
      - ../services/ml-engine:/app
      - ml_venv:/app/.venv
    depends_on:
      - redis
      - rabbitmq
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
    networks:
      - greenly_network
  # ==============================
  # CATALOG SERVICE (GO)
  # ==============================
  catalog-service:
    build:
      context: ../services/catalog-service
      dockerfile: Dockerfile.dev

    depends_on:
      - rabbitmq
      - mongodb

    environment:
      RABBITMQ_URL: amqp://guest:guest@rabbitmq:5672/
      MONGODB_URI: mongodb://root:root@mongodb:27017/?authSource=admin

    develop:
      watch:
        - action: sync
          path: ../services/catalog-service
          target: /app

        - action: rebuild
          path: ../services/catalog-service/go.mod

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.catalog.rule=PathPrefix(`/api/catalog`)"
      - "traefik.http.routers.catalog.entrypoints=web"
      - "traefik.http.services.catalog.loadbalancer.server.port=8081"
      - "traefik.http.middlewares.catalog-strip.stripprefix.prefixes=/api/catalog"
      - "traefik.http.routers.catalog.middlewares=catalog-strip"

    networks:
      - greenly_network